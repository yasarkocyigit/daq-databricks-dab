gold_model:
  name: dim_salesperson
  type: materialized_view
  description: "Sales person dimension with quota history"

  source_tables:
    - silver.salesperson
    - silver.salespersonquotahistory

  sql: |
    SELECT
      sp.BusinessEntityID AS salesperson_key,
      sp.TerritoryID,
      sp.SalesQuota,
      sp.Bonus,
      sp.CommissionPct,
      sp.SalesYTD,
      sp.SalesLastYear,
      q.latest_quota,
      q.latest_quota_date,
      current_timestamp() AS etl_timestamp
    FROM LIVE.salesperson sp
    LEFT JOIN (
      SELECT
        BusinessEntityID,
        SalesQuota AS latest_quota,
        QuotaDate AS latest_quota_date,
        ROW_NUMBER() OVER (PARTITION BY BusinessEntityID ORDER BY QuotaDate DESC) AS rn
      FROM LIVE.salespersonquotahistory
    ) q ON sp.BusinessEntityID = q.BusinessEntityID AND q.rn = 1

  quality:
    expectations:
      - name: "salesperson_key_not_null"
        constraint: "salesperson_key IS NOT NULL"
        action: fail
